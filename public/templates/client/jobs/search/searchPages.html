<jobs-search-pages-client class="section container jobs__search__pages">

    <div class="row">
        <div class="col-md-offset-19 col-md-5">
            <div class="row jobs__search__pages__items">
                <div if={ $State.get("pages") > 1 } class="jobs__search__pages__arrows">
                    <div onClick={ onPrev } onUpdate="none" class="jobs__search__pages__arrow" data-arrow="prev" data-active={ $State.get("page") > 0 }>Alt + ←</div>
                    <div onClick={ onNext } onUpdate="none" class="jobs__search__pages__arrow" data-arrow="next" data-active={ $State.get("page") + 1 < $State.get("pages") }>Alt + →</div>
                </div>
                <virtual each={ item, i in get.pages() } no-reorder>
                    <span onClick={ onSelect } class="col-md-4 jobs__search__pages__item" data-active={ item == $State.get("page") }>{ item + 1 }</span>
                </virtual>
            </div>
        </div>
    </div>

    <script>

        var $ = this;

        $.perPage = 5;

        $.on("mount", function(){
            $Sections.module("search.pages", $);

            app.$dom.document.on("keydown", function(e){
                if (e.altKey){
                    if (e.keyCode == 37){
                        $.onPrev();
                    }
                    else if (e.keyCode == 39){
                        $.onNext();
                    }
                }
            });
        });

        $.onSelect = function(){
            $.changePage(parseInt(this.item));
        };

        $.onNext = function(){
            if ($State.get("page") + 1 < $State.get("pages")){
                $.changePage($State.get("page") + 1);
                $.update();
            }
        };

        $.onPrev = function(){
            if ($State.get("page") > 0){
                $.changePage($State.get("page") - 1);
                $.update();
            }
        };

        $.changePage = function(page){
            $State.select("page").set(page);

            var params = Url.parseQuery();

            if (page > 0) params.page = page;
            else if (params.page) delete params.page;

            $Sections.search.filter.onSearch($Sections.search.filter.getUrl(params), true);
        };

        $.get = {
            pages: function(){
                var page = $State.get("page"),
                    pages = $State.get("pages");

                if (pages < 2) return;

                if (page + $.perPage <= pages){
                    if (page > 0){
                        return _.range(page - 1, page + ($.perPage - 1));
                    }
                    else {
                        return _.range(page, page + $.perPage);
                    }
                }
                else {
                    var delta = pages - page;
                    if (delta < 2) delta = 2;
                    else delta = 2;
                    if (page - delta < 0) delta = page;
                    if ((pages - (page - delta)) > $.perPage) pages = pages - 1;
                    return _.range(page - delta, pages);
                }
            }
        };

    </script>

</jobs-search-pages-client>
