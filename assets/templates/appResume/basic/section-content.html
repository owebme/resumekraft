<resume-edit-content>

    <resume-screens></resume-screens>

    <resume-control-percentage></resume-control-percentage>

    <resume-control-step></resume-control-step>

    <resume-control-buttons></resume-control-buttons>

    <resume-control-menu></resume-control-menu>

    <share-button pos="bottom-right"></share-button>

    <resume-preview></resume-preview>

    <resume-settings></resume-settings>

    <photo-upload></photo-upload>

    <resume-convert-pdf></resume-convert-pdf>

    <resume-edit-finish></resume-edit-finish>

    <div if={ !app.device.isPhone } class="share__text">Поделиться своим резюме в социальных сетях</div>

<script>

    var $ = this;

    $.on("before-mount", function(){

        $.scope = $.opts.scope;
        $.scroll = $.opts.scroll;
        $.content = $.opts.content;

        $.sections = {
            screens: $.tags["resume-screens"],
            menu: $.tags["resume-control-menu"],
            steps: $.tags["resume-control-step"],
            buttons: $.tags["resume-control-buttons"],
            percentage: $.tags["resume-control-percentage"],
            preview: $.tags["resume-preview"],
            settings: $.tags["resume-settings"],
            photo: $.tags["photo-upload"],
            pdf: $.tags["resume-convert-pdf"],
            finish: $.tags["resume-edit-finish"],
            shareButton: $.tags["share-button"]
        };
    });

    $.on("mount", function(){

        $.shareButtonEl = $$($.sections.shareButton.root);

        $.shareButtonEl.on("mouseenter mouseleave", function(e){
            if (e.type === "mouseenter"){
                $.scope.root.setAttribute("data-overlay", "true");
            }
            else {
                $.scope.root.setAttribute("data-overlay", "false");
            }
        });

        $store.resume.on("write", function(e){
            var prop = e.data.path[0];
            if (prop == "lang"){
                $i18n.lang($resume.get("lang"));
                moment.locale($resume.get("lang"));
                $.update();
            }
        });

        // if (!app.device.isPhone){
        //     _.onEndTransition($.content, function(){
        //         $Tutorial.show($$($.scope.root), "resumeBasic");
        //     });
        // }
    });

    $.refresh = function(){
        if (!$.screens) return;
        $.screens.refresh();
        $.sections.steps.refresh();
    };

    $.open = {
        menu: function(){
            $.sections.menu.show();
        },
        preview: function(){
            $.sections.preview.show();
            app.metrika.set("resume.create.control.preview", true);
        },
        photoUpload: function(){
            $.sections.photo.show(function(image){
                $resume.select("photo").set(image);
                $.sections.preview.template.update();
            });
            app.metrika.set("resume.create.control.photoUpload", true);
        },
        design: {
            basic: function(){
                $Sections.resume.select.show("basic");
                app.metrika.set("resume.create.control.design", true);
            },
            premium: function(){
                $Sections.resume.select.show("premium");
            }
        },
        print: function(){
            app.metrika.set("resume.create.control.print", true);
        },
        settings: function(){
            $.sections.settings.show();
        }
    };

    $.get = {
        pdf: function(){

            $.sections.pdf.show();

            var photo = $resume.get("photo");

            app.request('addResumeConvertPdf', {
                id: $resume.get("_id"),
                plan: $resume.get("plan"),
                template: $resume.get("template"),
                photo: photo.match(/^data:image\/jpeg;base64,/) ? photo : null,
                content: $.sections.preview.get.content()
            })
            .then(function(data){
                if (data && data.pdf){
                    var oReq = new XMLHttpRequest();
                    oReq.open("GET", data.pdf, true);
                    oReq.responseType = "arraybuffer";
                    oReq.onload = function() {
                        var response = this.response;

                        $.sections.pdf.hide(function(){
                            if (data.photo){
                                $resume.select("photo").set(data.photo);
                            }
                            var file = new Blob([response], {type: "application/pdf"});
                            saveAs(file, "example.pdf");
                        });
                    };
                    oReq.send();
                }
            });

            app.metrika.set("resume.create.control.pdf", true);
        }
    };

    $.on("unmount", function(){
        $.screens.destroy();
        $store.resume.off("write");
        $.shareButtonEl.off();
    });

</script>

</resume-edit-content>
