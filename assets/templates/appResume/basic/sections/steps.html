<resume-control-step class="section steps">

    <div each={ item in items } class="steps__item" data-balloon={ item.title } data-balloon-pos="left">
        <div onClick={ onChange } class="steps__item__button" data-active={ item.step == step }>{ item.step }</div>
    </div>

<script>

    var $ = this;

    $.step = "1";
    $.items = [];
    $.sliding = false;

    $.on("mount", function(){
        var screens = $.parent.screens.scope.data('marquee').screens;

        _.each($.parent.sections.screens.tags, function(item, key){
            if (key.match(/resume-screen/)){
                $.items.push({
                    title: item.opts.title,
                    step: item.opts.step,
                    offset: screens[item.opts.step - 1].offset,
                    size: screens[item.opts.step - 1].size
                });
            }
        });

        $.update();

        var _onScroll = _.throttle($.onScroll, 20),
            scroll = $.parent.screens.get("scroll");

        (function animationLoop(){
            app.utils.raf(animationLoop);
            _onScroll(app.utils.getScroll(scroll));
        })();
    });

    $.refresh = function(){
        var screens = $.parent.screens.scope.data('marquee').screens;

        _.each($.items, function(item, i){
            $.items[i].offset = screens[i].offset;
            $.items[i].size = screens[i].size;
        });
    };

    $.onChange = function(){
        $.sliding = true;
        $.step = this.item.step;
        $.parent.screens.nav($.step);

        setTimeout(function(){
            $.sliding = false;
        }, 600);
    };

    $.onScroll = function(scroll){
        if ($.sliding) return;

        var delta = app.sizes.height / 2.7,
            step = _.findWhere($.items, {"step": $.step}),
            next = _.findWhere($.items, {"step": String($.step * 1 + 1)}),
            prev = $.step > 1 ? _.findWhere($.items, {"step": String($.step * 1 - 1)}) : null;

        if (next && scroll.y + delta > next.offset){
            $.update({
                step: next.step
            });
        }
        else if (prev && scroll.y + delta < step.offset){
            $.update({
                step: prev.step
            });
        }
    };

</script>

</resume-control-step>
