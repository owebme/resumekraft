<ui-input class={ opts.autosuggestsize ? 'display-block input-autosuggest input-autosuggest-' + opts.autosuggestsize : 'display-block input-autosuggest input-autosuggest-m' }>

    <input name="input" onInput={ onInput } onUpdate={ opts.onupdate ? opts.onupdate : "none" } class="input input-{ opts.size ? opts.size : 'm' } { opts.color } { opts.align ? 'text-' + opts.align : '' } { input-rounded : opts.rounded }" value={ value } placeholder={ opts.placeholder } disabled={ typeof opts.disabled !== 'undefined' } type="text" autocomplete="off" spellcheck="false">

    <div if={ opts.autosuggest } class="input-autosuggest-items"><div onClick={ autosuggest.select } each={ item in autosuggest.items } no-reorder class="input-autosuggest-item">
        <div class="input-autosuggest-item-title">{ item.text }</div>
    </div></div>

<script>

    var $ = this;

    $.on("before-mount", function(){
        if ($.opts.update && $.opts.cursor){
            $.value = $.opts.cursor.get($.opts.update);
        }
        else {
            $.value = $.opts.value;
        }
        if ($.opts.autosuggest){
            $.suggest = _.debounce($.autosuggest.request, app.device.isMobile ? 300 : 150);
        }
    });

    $.on("mount", function(){
        if (!window.$$ || window.$$ && !$$.fn.mask) return;
        if ($.opts.pattern || $.opts.mask){
            var $input = $$($.input);
            if ($.opts.pattern){
                $input.mask($.opts.pattern);
            }
            else if ($.opts.mask){
                if ($.opts.mask == "phone"){
                    $input.mask("(000) 000-0000");
                }
            }
        }
    });

    $.on("update", function(){
        if ((!$.opts.value || !$.opts.onupdate) && $.opts.update && $.opts.cursor){
            $.value = $.opts.cursor.get($.opts.update);
            $.input.value = $.value;
        }
        else if ($.opts.value && $.opts.value !== $.value){
            $.value = $.opts.value;
            $.input.value = $.value;
        }
    });

    $.onInput = function(e){
        var value = e.target.value;

        $.onUpdate(this, value);

        if ($.opts.autosuggest && value){
            $.autosuggest.el = e.target;
            $.suggest($.opts.autosuggest, value);
            document.removeEventListener('click', $.autosuggest.handleClickOutside);
            document.addEventListener('click', $.autosuggest.handleClickOutside);
        }
    };

    $.onUpdate = function(_this, value){
        if ($.opts.update && $.opts.cursor){
            $.opts.cursor.set($.opts.update, value);
        }
        if ($.opts.commit === true || $.opts.commit == "true") $.parent.update();
        else if (_.isFunction($.opts.commit)) {
            $.opts.commit.call(_this, value, $.opts.i);
        }
        else if ($.opts.commit && $.parent[$.opts.commit]){
            $.parent[$.opts.commit](value, $.opts.i);
        }
    };

    $.autosuggest = {

        el: null,

        value: "",

        items: [],

        select: function(){
            $.autosuggest.update([], this.item.text);
        },

        request: function(method, value){
            if (value.length > 1){
                app.request(method, value).then(function(data){
                    if (data.items){
                        if (data.items.length == "1" && value == data.items[0].text){
                            $.autosuggest.items = [];
                            return;
                        }
                        else {
                            $.autosuggest.update(data.items);
                        }
                    }
                })
            }
            else {
                $.autosuggest.update([]);
            }
        },

        update: function(items, value){
            $.autosuggest.items = items;
            if (value){
                $.update({
                    value: value
                })
                $.onUpdate(this, value);
            }
            else {
                $.update();
            }
        },

        handleClickOutside: function(e){
            if ($.autosuggest.el && !$.autosuggest.el.contains(e.target)){
                setTimeout(function(){
                    $.autosuggest.update([]);
                }, 20);
            }
            document.removeEventListener('click', $.autosuggest.handleClickOutside);
        }
    };

    $.on("unmount", function(){
        if ($.opts.pattern || $.opts.mask){
            $$($.input).unmask();
        }
    });

</script>

</ui-input>
